<!DOCTYPE html>
<meta charset="utf-8">

<body>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://d3js.org/topojson.v1.min.js"></script>
  <!-- I recommend you host this file on your own, since this will change without warning -->
  <script src="http://datamaps.github.io/scripts/datamaps.world.min.js?v=1"></script>
  <script src="http://datamaps.github.io/scripts/datamaps.world.min.js"></script>
  <div id="container1" style="position: relative; width: 80%; max-height: 450px;"></div>


 <input id="slider" type="range" min="1960" max="2010" value="1960" step="1" />
	<span id="range">1960</span>
	<script src="https://raw.github.com/fryn/html5slider/master/html5slider.js"></script>
		<script type="text/javascript">
     
onload = function() {
  var $ = function(id) { return document.getElementById(id); };
  $('slider').oninput = function() { $('range').innerHTML = this.value; };
  $('slider').oninput();
};

</script>

     <script>

var width = 960,
    height = 600;


      var
        color_q0 = 'rgb(198,219,239)',
        color_q1 = 'rgb(158,202,225)',
        color_q2 = 'rgb(107,174,214)',
        color_q3 = 'rgb(66,146,198)',
        color_q4 = 'rgb(33,113,181)',
        color_q5 = 'rgb(8,81,156)',
        color_q6 = 'rgb(8,48,107)',
        colorScale = [
          color_q0,
          color_q1,
          color_q2,
          color_q3,
          color_q4,
          color_q5,
          color_q6
        ] // array used to generate color scale

      // input: 0 to 10 percent of GDP
      // output: q0 through q8
      //var quantize = d3.scale.quantize()
      //  .domain([0, 16])
      //  .range(d3.range(7).map(function(i) { return "q" + i; }));

      var quantize = d3.scale.threshold()
        .domain([0.38, 0.68, 0.97, 1.33, 1.91, 2.99, 17.14])
        .range(d3.range(7).map(function(i) { return "q" + i; }));

      var jsonMilExp = {};

      var map = new Datamap({
          element: document.getElementById('container1'),
          projection: 'mercator',
          fills: {
            defaultFill: 'rgb(222,235,247)',
            // define colors for quantized scale
            q0: color_q0,
            q1: color_q1,
            q2: color_q2,
            q3: color_q3,
            q4: color_q4,
            q5: color_q5,
            q6: color_q6
          },
          data: jsonMilExp,
          geographyConfig: {
            popupTemplate: function(geo, data) {
 		if (data == null)
                return '<div class="hoverinfo"><strong>No data available for ' + 				geo.properties.name + '</strong></div>';
                return ['<div class="hoverinfo"><strong>', 
                       geo.properties.name, 
                   '<br/>Year: ' + data.Year, 
                   //'<br/>CO2 Intensity: ' + Math.round(data.Tech*1000)/1000,
                   '<br/>CO2 Intensity: ' + data.Tech,
                   //'<br/>GDP: ' + Math.round(data.GDP*1000)/1000, 
                   '<br/>GDP: ' + data.GDP,
                        '</strong></div>'].join('');
                       }
        },
          responsive: true
        });

var load_data = function(Year) {
    d3.csv("data_co2.csv", function (error, data) {
          data.filter(function(d) {return +d.Year === Year})
          //data
            .forEach(function(d) {
                // create data for map
                jsonMilExp[d.Isocode ] = {
                  Iso: d.Isocode,
                  fillKey: quantize(d.Tech),
                  Year: +d.Year,
                  Tech: +d.Tech,
                  GDP: +d.GDP
                };
                map.updateChoropleth(jsonMilExp);
              });
            });   
};

load_data(1960);


d3.selectAll("input").on("change", function change() {
    var Year = +this.value;
    load_data(Year);
});


// append the container for the legend
d3.select('svg')
  .append('g')
  .attr('class', 'legend');

var
  legendBarWidth = 30,
  legendBarHeight = 10,
  legendOffsetX = 30,
  legendOffsetY = 400;


var date = ["2.99" + "-" + "17.14", "1.91" + "-" + "2.99",
   "1.33" + "-" + "1.91", "0.97" + "-" + "1.33", "0.68" + "-" + "0.97",
    "0.38" + "-" + "0.68", "0" + "-" + "0.38" ];
 

// draw the legend
d3.select('.legend').selectAll('.legend')
.data(colorScale)
.enter()
  .append('rect')
    .attr('x', legendOffsetX)
    .attr('y', function(d,i) {
      return legendOffsetY + legendBarHeight*i;
    })
    .attr('width', legendBarWidth)
    .attr('height', legendBarHeight)
    .attr('fill', function(d){ return d; });

d3.select('.legend').selectAll('.legend')
.data(colorScale)
.enter()
  .append('text')
    .text(function(d,i){
      var quantizedRange = quantize.invertExtent('q'+i);
      return date[i];
    })
    .attr('x', legendOffsetX+(legendBarWidth*1.25))
    .attr('y', function(d,i){
      return legendOffsetY + (legendBarHeight*0.9) + legendBarHeight*i;
    })
    .attr("font-family", "sans-serif")
    .attr("font-size", "10px")
    .attr("fill", "black");




  </script>
   

</body>
